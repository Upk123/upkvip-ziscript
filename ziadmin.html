<!doctype html>
<html lang="my">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ZI Admin — One-Time Key Console</title>
<style>
  :root{
    --bg:#0b1020; --card:#11172b; --muted:#8aa0c8; --fg:#e7eefc; --bd:#263252;
    --brand:#7aa2ff; --ok:#5ee17a; --bad:#ff6b6b; --warn:#ffd166;
  }
  *{box-sizing:border-box} body{margin:0; background:linear-gradient(180deg,#0b1020,#0b1020 40%,#0e1630);
    color:var(--fg); font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; }
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
  .logo{width:52px;height:52px;border-radius:12px;background: #1a2340; display:flex;align-items:center;justify-content:center;
        box-shadow: 0 6px 18px rgba(0,0,0,.35)}
  .logo span{font-weight:800;color:#cfe2ff}
  h1{margin:0;font-size:1.6rem;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem;margin-top:2px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;margin:14px 0}
  label{display:block;margin:8px 0 6px;color:#cfe2ff}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#0f1a32;color:var(--fg)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--bd);background:#142247;color:var(--fg);
       padding:10px 14px;border-radius:999px;cursor:pointer}
  .btn.primary{background:var(--brand); color:#0b1020; border-color:transparent; font-weight:700}
  .btn.warn{background:#1f2640;border-color:#3a4878}
  .btn:hover{filter:brightness(1.05)}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--bd);background:#0e1833;color:#cfe2ff}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warnc{color:var(--warn)}
  code,kbd{background:#0f1a32;border:1px solid var(--bd);border-radius:8px;padding:2px 6px}
  pre{white-space:pre-wrap;word-break:break-word;background:#0f1a32;border:1px solid var(--bd);border-radius:10px;padding:12px}
  .grid-3{display:grid;grid-template-columns:1.1fr .9fr .9fr;gap:12px}
  .keybox{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:1.05rem}
  .right{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .hr{height:1px;background:var(--bd);margin:12px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><span>ZI</span></div>
      <div style="flex:1">
        <h1>ZI Admin — One-Time Key Console</h1>
        <div class="sub">API URL + Admin Secret ထည့်ပြီး Connect → Create Key ပြုလုပ်ပါ</div>
      </div>
      <div class="right">
        <span id="healthBadge" class="pill"><span>Health:</span><b class="muted">unknown</b></span>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>API URL (HTTPS ဥပမာ: <code>https://api.yourdomain.com</code>)</label>
          <input id="apiUrl" placeholder="https://api.yourdomain.com">
        </div>
        <div>
          <label>Admin Secret</label>
          <input id="adminSecret" type="password" placeholder="••••••••">
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="btnHealth">Check Health</button>
        <button class="btn primary" id="btnConnect">Connect</button>
        <button class="btn warn" id="btnSave">Save to Browser</button>
        <span class="muted" id="connMsg"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Create One-Time Key</h3>
      <div class="grid-3">
        <div>
          <label>Note (optional)</label>
          <input id="note" placeholder="e.g. VPS-01 setup">
        </div>
        <div>
          <label>Endpoint (Create)</label>
          <select id="createPath">
            <option value="/api/key">/api/key</option>
            <option value="/api/keys/create">/api/keys/create</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnCreate">Create Key</button>
        </div>
      </div>
      <div class="hr"></div>
      <label>Generated Key</label>
      <input id="genKey" class="keybox" readonly placeholder="— no key yet —">
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button class="btn" id="btnCopy">Copy Key</button>
        <button class="btn" id="btnMakeCurl">Make cURL for User</button>
        <span class="muted" id="keyMsg"></span>
      </div>
      <div id="curlWrap" style="display:none;margin-top:12px">
        <label>User Command (example)</label>
        <pre id="curlText"></pre>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Validate Key (စမ်းသပ်용)</h3>
      <div class="row">
        <div>
          <label>Key</label>
          <input id="valKey" class="keybox" placeholder="paste key to test">
        </div>
        <div>
          <label>Endpoint (Validate)</label>
          <select id="validatePath">
            <option value="/api/validate">/api/validate</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button class="btn" id="btnValidate">Validate</button>
        <span id="valMsg" class="muted"></span>
      </div>
    </div>

    <div class="muted" style="text-align:center;margin:22px 0 6px">
      ZI Admin UI • Single-file HTML • Save API settings locally only (localStorage)
    </div>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const apiInput = $('#apiUrl');
  const secretInput = $('#adminSecret');
  const connMsg = $('#connMsg');
  const healthBadge = $('#healthBadge').querySelector('b');

  // Restore saved settings
  (function restore(){
    const saved = JSON.parse(localStorage.getItem('ziadmin') || '{}');
    if(saved.api) apiInput.value = saved.api;
    if(saved.secret) secretInput.value = saved.secret;
  })();

  function saveLocal(){
    localStorage.setItem('ziadmin', JSON.stringify({
      api: apiInput.value.trim(),
      secret: secretInput.value
    }));
    connMsg.textContent = 'Saved.';
    setTimeout(()=>connMsg.textContent='', 1500);
  }

  async function ping() {
    const base = apiInput.value.trim().replace(/\/+$/,'');
    if(!base){ return setHealth('bad','no api'); }
    try{
      const r = await fetch(base + '/healthz', {method:'GET', mode:'cors'});
      if(!r.ok){ setHealth('bad', 'http '+r.status); return; }
      const j = await r.json().catch(()=>({}));
      setHealth('ok','ok');
      return j;
    }catch(e){
      setHealth('bad','offline');
    }
  }

  function setHealth(state, text){
    healthBadge.textContent = text || state;
    if(state==='ok'){ healthBadge.classList.remove('bad'); healthBadge.classList.add('ok'); }
    else { healthBadge.classList.remove('ok'); healthBadge.classList.add('bad'); }
  }

  async function connect(){
    saveLocal();
    connMsg.textContent = 'Connecting...';
    await ping();
    connMsg.textContent = 'Done.';
  }

  async function createKey(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const secret = secretInput.value;
    const path = $('#createPath').value;
    if(!base || !secret){ return note('keyMsg','API URL / Secret လိုအပ်သည်', true); }
    try{
      const r = await fetch(base + path, {
        method:'POST',
        mode:'cors',
        headers:{'X-Admin-Secret': secret}
      });
      const j = await r.json();
      if(!r.ok || !j.ok){ throw new Error(j.error || ('HTTP '+r.status)); }
      $('#genKey').value = j.key || '';
      note('keyMsg','Key generated ✔', false);
      $('#curlWrap').style.display='none';
    }catch(e){
      note('keyMsg','Create failed: '+e.message, true);
    }
  }

  function makeCurl(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const key = $('#genKey').value.trim();
    if(!base || !key){ return; }
    const cmd = `curl -X POST ${base}/api/validate -H 'Content-Type: application/json' -d '{"key":"${key}"}'`;
    $('#curlText').textContent = cmd;
    $('#curlWrap').style.display = 'block';
  }

  async function validate(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const path = $('#validatePath').value;
    const key = $('#valKey').value.trim();
    if(!base || !key){ return note('valMsg','API URL / Key လိုအပ်သည်', true); }
    try{
      const r = await fetch(base + path, {
        method:'POST',
        mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({key})
      });
      const j = await r.json();
      if(!r.ok || !j.ok){ throw new Error(j.error || ('HTTP '+r.status)); }
      note('valMsg','✓ valid (one-time consumed)', false);
    }catch(e){
      note('valMsg','✗ '+e.message, true);
    }
  }

  function note(id, text, isErr){
    const el = $('#'+id);
    el.textContent = text;
    el.style.color = isErr ? 'var(--bad)' : 'var(--ok)';
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.textContent=''; }, 3000);
  }

  async function copyKey(){
    const v = $('#genKey').value.trim();
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      note('keyMsg','Copied.', false);
    }catch(_){
      note('keyMsg','Copy failed.', true);
    }
  }

  // Bind
  $('#btnSave').onclick = saveLocal;
  $('#btnHealth').onclick = ping;
  $('#btnConnect').onclick = connect;
  $('#btnCreate').onclick = createKey;
  $('#btnCopy').onclick = copyKey;
  $('#btnMakeCurl').onclick = makeCurl;
  $('#btnValidate').onclick = validate;

  // First health check (if URL saved)
  if(apiInput.value) ping();
</script>
</body>
</html>
