<!doctype html>
<html lang="my">
<head>
  <meta charset="utf-8">
  <title>ZI Admin — One-Time Key Console (HTTP)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0b1220;--card:#101728;--fg:#e6ebff;--muted:#8aa0c8;--bd:#1e2a44;
          --ok:#2ecc71;--bad:#ff6b6b;--btn:#182443;--btnbd:#2b3b63}
    html,body{background:#0b1220;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:920px;margin:28px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;margin:14px 0}
    h1{margin:0 0 8px 0;font-size:1.6rem}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1 1 280px}
    label{display:block;color:var(--muted);font-size:.9rem;margin:2px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--bd);
      background:#0c1426;color:var(--fg)}
    button{padding:10px 14px;border-radius:999px;border:1px solid var(--btnbd);background:var(--btn);
      color:var(--fg);cursor:pointer}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd)}
    .ok{color:var(--ok);border-color:var(--ok)}
    .bad{color:var(--bad);border-color:var(--bad)}
    pre{white-space:pre-wrap;background:#0c1426;border:1px solid var(--bd);padding:12px;border-radius:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ZI Admin — One-Time Key Console <span id="health" class="pill">health: …</span></h1>
  <div class="card">
    <div class="row">
      <div>
        <label>API URL (HTTP)</label>
        <input id="api" placeholder="http://43.229.135.219:8088">
      </div>
      <div>
        <label>Admin Secret</label>
        <input id="secret" placeholder="newapi">
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="save()">Save</button>
      <button onclick="checkHealth()">Check Health</button>
      <button onclick="connect()">Connect</button>
    </div>
    <div class="muted" style="margin-top:8px">
      UI ကို HTTPS ထဲထည့်ရင် HTTP API ကို Browser က ပိတ်နိုင်တယ် – ဒီဖိုင်ကို HTTP ပေါ်ကနေဖွင့်ပါ။
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Create One-Time Key</h3>
    <div class="row">
      <div>
        <label>Endpoint</label>
        <input id="epCreate" value="/api/key">
      </div>
      <div>
        <label>Note (optional, client-side only)</label>
        <input id="note">
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="createKey()">Create Key</button>
      <button onclick="copyGen()">Copy Key</button>
      <button onclick="makeCurl()">Make cURL for User</button>
    </div>
    <label style="margin-top:10px">Generated Key</label>
    <input id="gen" readonly placeholder="— no key yet —">
    <label style="margin-top:10px">cURL (for user)</label>
    <textarea id="curl" rows="3" readonly></textarea>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Validate Key</h3>
    <div class="row">
      <div>
        <label>Key</label>
        <input id="keyToTest" placeholder="paste key to test">
      </div>
      <div>
        <label>Endpoint</label>
        <input id="epValidate" value="/api/validate">
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="validateKey()">Validate</button>
    </div>
    <pre id="out" class="muted">result will appear here…</pre>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);
  function base(){ return (el('api').value||'').replace(/\/+$/,''); }
  function secret(){ return el('secret').value||''; }
  function save(){
    localStorage.setItem('zi_api', el('api').value);
    localStorage.setItem('zi_secret', el('secret').value);
    alert('Saved.');
  }
  function load(){
    const api = localStorage.getItem('zi_api')||'';
    const sec = localStorage.getItem('zi_secret')||'';
    if(api) el('api').value = api;
    if(sec) el('secret').value = sec;
  }
  async function checkHealth(){
    setHealth('checking…');
    try{
      const r = await fetch(base() + '/healthz', {cache:'no-store'});
      const ok = r.ok;
      setHealth(ok ? 'online' : 'offline', ok);
    }catch(e){
      setHealth('offline', false);
    }
  }
  function connect(){ // Just health + remember
    save(); checkHealth();
  }
  function setHealth(text, ok){
    const h = el('health');
    h.textContent = 'health: ' + text;
    h.className = 'pill ' + (ok===true ? 'ok':'bad');
  }

  async function createKey(){
    try{
      const r = await fetch(base() + (el('epCreate').value||'/api/key'), {
        method:'POST',
        headers: {'X-Admin-Secret': secret()},
      });
      const j = await r.json();
      if(j && j.key){
        el('gen').value = j.key;
        el('out').textContent = JSON.stringify(j, null, 2);
      }else{
        el('out').textContent = 'Unexpected response: ' + JSON.stringify(j);
      }
    }catch(e){
      el('out').textContent = 'Create error: ' + e;
    }
  }
  function copyGen(){
    const v = el('gen').value||'';
    if(!v){ alert('no key yet'); return; }
    navigator.clipboard.writeText(v); alert('Copied.');
  }
  function makeCurl(){
    const k = el('gen').value||'YOUR_KEY_HERE';
    const cmd = `curl -s -X POST "${base() + '/api/validate'}" -H "Content-Type: application/json" -d '{"key":"${k}"}'`;
    el('curl').value = cmd;
  }
  async function validateKey(){
    const k = el('keyToTest').value || el('gen').value || '';
    if(!k){ alert('no key'); return; }
    try{
      const r = await fetch(base() + (el('epValidate').value||'/api/validate'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({key:k})
      });
      const j = await r.json();
      el('out').textContent = JSON.stringify(j, null, 2);
    }catch(e){
      el('out').textContent = 'Validate error: ' + e;
    }
  }
  load(); checkHealth();
</script>
</body>
</html>      api: apiInput.value.trim(),
      secret: secretInput.value
    }));
    connMsg.textContent = 'Saved.';
    setTimeout(()=>connMsg.textContent='', 1500);
  }

  async function ping() {
    const base = apiInput.value.trim().replace(/\/+$/,'');
    if(!base){ return setHealth('bad','no api'); }
    try{
      const r = await fetch(base + '/healthz', {method:'GET', mode:'cors'});
      if(!r.ok){ setHealth('bad', 'http '+r.status); return; }
      const j = await r.json().catch(()=>({}));
      setHealth('ok','ok');
      return j;
    }catch(e){
      setHealth('bad','offline');
    }
  }

  function setHealth(state, text){
    healthBadge.textContent = text || state;
    if(state==='ok'){ healthBadge.classList.remove('bad'); healthBadge.classList.add('ok'); }
    else { healthBadge.classList.remove('ok'); healthBadge.classList.add('bad'); }
  }

  async function connect(){
    saveLocal();
    connMsg.textContent = 'Connecting...';
    await ping();
    connMsg.textContent = 'Done.';
  }

  async function createKey(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const secret = secretInput.value;
    const path = $('#createPath').value;
    if(!base || !secret){ return note('keyMsg','API URL / Secret လိုအပ်သည်', true); }
    try{
      const r = await fetch(base + path, {
        method:'POST',
        mode:'cors',
        headers:{'X-Admin-Secret': secret}
      });
      const j = await r.json();
      if(!r.ok || !j.ok){ throw new Error(j.error || ('HTTP '+r.status)); }
      $('#genKey').value = j.key || '';
      note('keyMsg','Key generated ✔', false);
      $('#curlWrap').style.display='none';
    }catch(e){
      note('keyMsg','Create failed: '+e.message, true);
    }
  }

  function makeCurl(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const key = $('#genKey').value.trim();
    if(!base || !key){ return; }
    const cmd = `curl -X POST ${base}/api/validate -H 'Content-Type: application/json' -d '{"key":"${key}"}'`;
    $('#curlText').textContent = cmd;
    $('#curlWrap').style.display = 'block';
  }

  async function validate(){
    const base = apiInput.value.trim().replace(/\/+$/,'');
    const path = $('#validatePath').value;
    const key = $('#valKey').value.trim();
    if(!base || !key){ return note('valMsg','API URL / Key လိုအပ်သည်', true); }
    try{
      const r = await fetch(base + path, {
        method:'POST',
        mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({key})
      });
      const j = await r.json();
      if(!r.ok || !j.ok){ throw new Error(j.error || ('HTTP '+r.status)); }
      note('valMsg','✓ valid (one-time consumed)', false);
    }catch(e){
      note('valMsg','✗ '+e.message, true);
    }
  }

  function note(id, text, isErr){
    const el = $('#'+id);
    el.textContent = text;
    el.style.color = isErr ? 'var(--bad)' : 'var(--ok)';
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.textContent=''; }, 3000);
  }

  async function copyKey(){
    const v = $('#genKey').value.trim();
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      note('keyMsg','Copied.', false);
    }catch(_){
      note('keyMsg','Copy failed.', true);
    }
  }

  // Bind
  $('#btnSave').onclick = saveLocal;
  $('#btnHealth').onclick = ping;
  $('#btnConnect').onclick = connect;
  $('#btnCreate').onclick = createKey;
  $('#btnCopy').onclick = copyKey;
  $('#btnMakeCurl').onclick = makeCurl;
  $('#btnValidate').onclick = validate;

  // First health check (if URL saved)
  if(apiInput.value) ping();
</script>
</body>
</html>
